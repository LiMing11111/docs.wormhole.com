# 核心合约

## 核心合约（Core Contract）

核心合约是发布所有 Wormhole 信息的机制。所有跨链应用程序要么直接与核心合约交互，要么与其他合约交互。生态系统中的每个区块链上都有一个核心合约，这是守护者必须遵守的合约。核心合约也是最终向守护者发出观察信息的合约。

一般来说，核心合约很简单，可以分解为**发送**和**接收**，我们接下来将对其进行定义。

### 发送（Sending）

目前发布消息是免费的（在 Solana 上发布除外），但不能保证将来始终如此。

publishMessage 的实施策略因链而异，但一般策略包括核心合约将 emitterAddress（调用 publishMessage 的合约）、sequenceNumber 和 consistencyLevel 发布到区块链日志中。一旦达到所需的一致性级别（consistencyLevel），并且消息通过了守护者的所有可选检查，守护者网络就会生成所请求的 VAA。

用于发布信息的签名方法：

```solidity
publishMessage(
    int nonce,
    byte[] payload,
    int consistencyLevel
) returns int sequenceNumber
```

#### **参数（**Parameters）

**payload**

发出的消息的内容，由任意字节数组构成。由于各个区块链的限制，它的最大长度可能会有一些限制。

**consistencyLevel**

{% hint style="info" %}
一些高级集成商可能希望在最终确定之前获取消息，这是 `consistency_level` 字段提供链特定灵活性的的地方。
{% endhint %}

&#x20;`consistency_level` 可以看作是一个数值 `enum` 数据类型，不同链的值会有不同的处理方式。

它描述了在守护者观察和证明所发出的事件之前必须达到的最终性级别。这是对重写和回滚的一种防御，因为事务一旦被认为是 `final`, 就能保证它引起的状态变化不会被回滚。

不同的链使用不同的共识机制，因此每个链都有不同的最终性假设，请参阅 Environments 页面中的最终性选项。

**nonce**

一个免费的整数字段，可以按照开发人员的意愿使用。请注意，不同的 `nonce` 将导致不同的摘要。

#### Returns

**sequenceNumber**

一个唯一的数字，在给定 emitter（隐含链）的每条信息中都会递增。该编号与 emitter address 和 emitter chain ID 相结合，允许从 API 接口查询此消息的 VAA。

### 接收（Receiving）

用于接收消息的签名方法，编码为 VAA：

```solidity
parseAndVerifyVAA(byte[] VAA)
```

当传递 VAA 时，此函数将返回 VAA 的 payload 和相关元数据，或者引发异常。只有在 VAA 无法通过签名验证时才会抛出异常，这表明 VAA 在某种形式上无效或不真实。

{% hint style="info" %}
开发人员应注意确保在执行传递 VAA 的交易期间调用此方法，以确保检查和验证签名。
{% endhint %}

### 组播（Multicast）

请注意，这些函数中没有目标地址或链。

VAA 只是证明 "这个链上的这个合约说明了这一事件"。因此，默认情况下，VAA 是组播的，并将在任何链上验证其真实性。

这种默认组播模型是设计中不可或缺的一部分。拥有这种组播能力可以轻松地在整个生态系统中同步状态，因为单个区块链可以通过单个操作以较低的延迟将其数据提供给每个链。这降低了将数据路由到大量区块链时遇到的 n^2 问题的复杂性。

这并不意味着应用程序无法指定目标地址或链。例如，代币桥（Token Bridge）和标准中继器合约要求在目标链上传递和验证一些目标详细信息。

由于 VAA 的创建与中继是分开的，因此在针对单个区块链时，组播模型不会产生额外成本。如果某个区块链不需要数据，就不要在那里转发，这样就不会产生任何成本。

## 其他提供的合约

### 代币桥（Token Bridge）

{% hint style="info" %}
在进行代币转移之前，所转移的代币必须作为包装资产存在于目标链上。这需要对目标链上的代币详细信息进行认证/证明。
{% endhint %}

代币桥合约允许通过锁定和铸造（lock and mint）机制在区块链之间进行代币传输，使用具有特定负载的核心合约来传递有关代币转移的信息。

代币桥还支持在令牌传输过程中附加任意字节有效载荷形式的数据。这种类型的转移称为合约控制转移（Contract Controlled Transfer）。

虽然核心合约默认情况下没有特定的接收方，但通过代币桥发送的转账确实有特定的接收链和地址，以确保代币被铸造给预期的接收方。

### NFT 桥（NFT Bridge）

NFT 桥的功能与代币桥类似，但对于可以传输的内容以及如何在目标链上创建包装版本有特殊的规则。
